<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>汇总查询</title>
    <!-- <link rel="stylesheet" href="http://i.gtimg.cn/vipstyle/frozenui/2.0.0/css/frozen.css"> -->

    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/icon.css">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/dialog.css">
    <link rel="stylesheet" href="../css/lCalendar.css">
    <link href="../css/select2.css" rel="stylesheet" /> 
    <link rel="stylesheet" href="../css/index.css">
    

    <style>
        .cardList li {
            height: auto;
        }
    </style>

</head>

<body>
    <nav>
        <a class="back centery" href="javascript:history.go(-1)">返回</a>
        <p class="navCon">汇总查询</p>
    </nav>

    <div class="content destoryC formEntry">

        <ul class="nav nav-tabs tabs-three" id="myTab">
            <li class="active" hid="tab1">
                <a href="javascript:;">查询条件</a>
            </li>
            <li hid="tab2">
                <a href="javascript:;">查询结果</a>
            </li>
            <li hid="tab3">
                <a href="javascript:;">图表</a>
            </li>

        </ul>

        <div class="tab-content">
            <div class="cardList tab-pane active" id="tab1">
                <div class="searchHeader imgBox">
                    <p class="clearfix">
                        <div class="checkTop">
                            <label class="hzRadioCheck ">
                                <input type="radio" class='radio' value="0101" checked />
                                <span>固定资产</span>
                            </label>
                            <label class="hzRadioCheck ">
                                <input type="radio" class='radio' value="0106" />
                                <span>无形资产</span>
                            </label>
                            <label class="hzRadioCheck ">
                                <input type="radio" class='radio' value="0201" />
                                <span>投资性房地产</span>
                            </label>
                        </div>
                        <p>
                            <label for="departCode">所属单位</label>
                            <select name="departCodeSelect" value="" id="departCodeSelect">

                            </select>
                        </p>
                        
                    </p>
                </div>


                <div class="searchHeader imgBox" style="margin-top: 60px; height: 800px;">

                    <a class="clearfix">
                        <label for="departName" style="display:inline-block; font-size: 0.64rem">所属单位</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%">
                            <div class="switch-block"></div>
                        </div>
                        <select name="group1" style="display:inline-block; width: 30%; margin-left: 10%" id="group1">
                            <option value="">三级分组</option>
                            <option value="">四级分组</option>
                            <option value="">五级分组</option>
                            <option value="">六级分组</option>
                        </select>


                    </a>

                    <a class="clearfix">
                        <label for="groupZclb" style="display:inline-block; font-size: 0.64rem">资产类别</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%">
                            <div class="switch-block"></div>
                        </div>
                        <select name="groupZclb" style="display:inline-block; width: 30%; margin-left: 10%" id="groupZclb">
                            <option value="2">大类汇总</option>
                            <option value="4">中类汇总</option>
                        </select>
                    </a>
                    <a class="clearfix">
                        <label for="groupJszk" style="display:inline-block; font-size: 0.64rem">技术状况</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%">
                            <div class="switch-block"></div>
                        </div>
                    </a>
                    <a class="clearfix">
                        <label for="groupSyzt" style="display:inline-block; font-size: 0.64rem;">使用状态</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%;margin-top:23px">
                            <div class="switch-block"></div>
                        </div>
                    </a>
                    <a class="clearfix">
                        <label for="groupZjyy" style="display:inline-block; font-size: 0.64rem;">增加原因</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%;margin-top:23px">
                            <div class="switch-block"></div>
                        </div>
                    </a>
                    <a class="clearfix">
                        <label for="groupZjqd" style="display:inline-block; font-size: 0.64rem;">资金渠道</label>

                        <div class="switch-bg turn-off" style="display:inline-block; position:relative;top:23px; margin-left: 10%; margin-top:23px">
                            <div class="switch-block"></div>
                        </div>
                    </a>
                </div>
                <bottom class=" bottomFixed BtnCurrent">
                    <button id="hzSearchBtn" class="bottomBtn center sc">查询</button>
                </bottom>
            </div>
            <div class="cardList tab-pane destory_tab2" id="tab3">
                
                <canvas id="yzChart"></canvas>
                <canvas id="jzChart"></canvas>
                <canvas id="ljzjChart"></canvas>
                <canvas id="jzzbChart"></canvas>
            </div>

            <div class="cardList tab-pane" id="tab2">
                <ul id="list1">
                    
                </ul>
                </div>

        </div>

    </div>

    <div class="bomb">
        <div class="bombCon">

        </div>
    </div>
    <div class="layBoxscan scan1">
        <span class='center'>加载中...</span>
    </div>
</body>
<script src="../js/jquery.min.js"></script>
<script src="../js/dialog.js"></script>
<script src="../js/cookie.js"></script>
<script src="../js/lCalendar.js"></script>
<script src="../js/hotcss.js"></script>
<script src="../js/doT.js"></script>
<script src="../js/fancySelect.js"></script>
<script src="../js/main.js"></script>
<script src="../js/chart.js"></script>
<script src="../js/select2.js"></script>


<script type="template" id="listCon1">  
        {{~it.data :value:index}}
        <li class="clearfix listli" data-index={{=index}} >  
            <p class="barCode">分组维度：{{= value.zclbmc }}</p>
            <span class="listInfo">
                <b><i>原值 ：{{= value.yz }}</i>  <i style="float:right">净值 ：{{= value.jz}}</i></b>
                <b><i>累计折旧 ：{{= value.ljzj }}</i>  <i style="float:right">减值准备 ：{{= value.jzzb}}</i></b>
            </span> 
        </li>
    {{~}}
</script>
<script>  
    $(".switch-bg").click(function () {
        debugger
        if ($(this).hasClass("turn-off")) {
            $(this).removeClass("turn-off");
            var turnOn = $(".turn-on");
            turnOn.removeClass("turn-on");
            turnOn.addClass("turn-off");

            $(this).addClass("turn-on");
            return;
        } else {
            $(this).removeClass("turn-on");
            $(this).addClass("turn-off");
        }
    });  
</script>

<script>
    debugger
    // $("#departCodeSelect").html("")
    // var departList = $.cookie('departList');
    // departList = JSON.parse(departList);
    // var str="";
    // $.each(departList,function(){
    //     str+="<option value="+this.departcode+">"+this.shortname+"</option>"
    // })
    // $("#departCodeSelect").html(str); 

    var strIN="",strINList='';    
    $.each(JSON.parse(localStorage.getItem('selOut')),function(index,i){  
        // if(index==0){
        //     $("#createDepartcode").val(this.departcode)
        // }
        strIN+="<option dp_code="+this.departcode+" value="+this.departcode+">"+this.departname+"</option>"
    })   
    
    $("#departCodeSelect").html(strIN);
    $("#departCodeSelect").select2();

    //先清除
    // if (window.JsCallback) {
    //     window.JsCallback.onClearScrapList();
    // } else {
    //     setupWebViewJavascriptBridge(function (bridge) {
    //         bridge.callHandler('onClearScrapList', function responseCallback(data) {

    //         })
    //     })
    // }
    // var getListUrl = getURL()+'/AssetsDataPhone/mobile/discardController.do?queryByCodeOrBar';
    // var departListStr = $.cookie('departList');
    // var userInfo = $.cookie('userinfo');  
    // departList = JSON.parse(departListStr)[0];
    // userInfo = JSON.parse(userInfo); 
    // var listAarray=[];  
    // var phoneInvoiceNumber = userInfo.usercode+userInfo.departcode+new Date().Format('yyyyMMddhhmmss');
    // var lcalendarData='1900-1-1'+',2030-12-31'
    // $("#stopDate").attr("data-lcalendar",lcalendarData); 
    // $("#stopDate").val(new Date().Format('yyyy-MM-dd')) 
    // var calendardatetime = new lCalendar();
    // calendardatetime.init({
    //     'trigger': '#stopDate ',
    //     'type': 'date',
    //     'minDate':'1900-1-1',//最小日期 注意：该值会覆盖标签内定义的日期范围
    // }); 
    // var str="";   
    //     $.each(JSON.parse(departListStr),function(index,i){  
    //         if(index==0){
    //             $("#departcode").val(this.departcode)
    //         }
    //         if(userInfo.departcode==this.departcode){
    //             str+="<option selected='true' value="+this.departcode+">"+this.shortname+"</option>" 
    //         }else{
    //             str+="<option value="+this.departcode+">"+this.shortname+"</option>" 
    //         }
    //     })
    // if (window.JsCallback) {  
    //     var mySelectDC = $('#departCode');
    //     mySelectDC.fancySelect(); 
    //     mySelectDC.append(str);
    //     mySelectDC.trigger('update'); 
    //     $('select').fancySelect();  
    // }else{
    //     var mySelectDC = $('#departCode'); 
    //     mySelectDC.append(str);
    //     $('#departCode').val(userInfo.departcode)
    // } 
    // $("input[name='departCode']").val(userInfo.departcode);
    // $("input[name='userCode']").val(userInfo.username); 
    // $(".userInfo .DepartName").text(userInfo.departname);
    // $(".userInfo .UserName").text(userInfo.username);  
    // $("input[name='createdate']").val(new Date().Format('yyyy-MM-dd')); 
    $(".checkTop input").click(function () {
        // alert(123)
        $(".checkSear input").val('');
        $(this).parent().siblings(".hzRadioCheck").find('input').attr("checked", false);
    })
    //搜索
    $("#hzSearchBtn").click(function () {
        debugger
        var jsons = {
            assetsType: $('input[class="radio"]:checked ').val(),
            // departCode: $("#departCodeSelect").val(),
            departCode: 14400,
            groupZclb: 2
        }
        debugger
        var url = getURL() + '/AssetsDataPhone/mobile/summaryController.do?querySummary';

        sendPost(url, jsons, ListA)
    })
    function ListA(data) {
        debugger
        if (data.success == 'true') {
            // listAarray.push(data.data);
            // var reslistAarray = listAarray.unique('barCode');
            // sessionStorage.setItem("form1", JSON.stringify(reslistAarray));
            // template(reslistAarray)
            
            var label = [];
            var yzData = [];
            var jzData = [];
            var ljzjData = [];
            var jzzbData = [];
            var backgroundColor = [];
            var boderColor = [];
            var defaultBackGround = [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ];
            var defaultBoderColor = [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ];
            data.data.forEach(function(value, index) {
                if (!value.yz) {
                    value.yz = 0;
                }
                if (!value.jz) {
                    value.jz = 0;
                }
                if (!value.ljzj) {
                    value.ljzj = 0;
                }
                if (!value.jzzb) {
                    value.jzzb = 0;
                }
                label.push(value.zclbmc);
                yzData.push(value.yz);
                jzData.push(value.jz);
                ljzjData.push(value.ljzj);
                jzzbData.push(value.jzzb);
                backgroundColor.push(defaultBackGround[index%6]);
                boderColor.push(defaultBoderColor[index%6]);
            });

            template(data.data);




            var ctx = document.getElementById("yzChart").getContext('2d');
            var yzChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: label,
                    datasets: [{
                        label: '原值分布图',
                        data: yzData,
                        backgroundColor: backgroundColor,
                        borderColor: boderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

            var ctx = document.getElementById("jzChart").getContext('2d');
            var jzChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: label,
                    datasets: [{
                        label: '净值分布图',
                        data: jzData,
                        backgroundColor: backgroundColor,
                        borderColor: boderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

            var ctx = document.getElementById("ljzjChart").getContext('2d');
            var ljzjChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: label,
                    datasets: [{
                        label: '累计折旧分布图',
                        data: ljzjData,
                        backgroundColor: backgroundColor,
                        borderColor: boderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });

            var ctx = document.getElementById("jzzbChart").getContext('2d');
            var jzzbChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: label,
                    datasets: [{
                        label: '减值准备分布图',
                        data: jzzbData,
                        backgroundColor: backgroundColor,
                        borderColor: boderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        } else {
            alert(data.msg)
        }
    }
    function template(data) {
        debugger
        var res = {};
        res.data = data;
        var tmpl = doT.template($("#listCon1").text());
        $("#list1").html(tmpl(res));
    }
    function dataInfo(data, id) {
        var list = $("#" + id + " p");
        $.each(list, function () {
            var target = $(this);
            var key = target.attr("name");
            var val = data[key];
            target.find("span").text(val == "" || val == null ? "--" : val);
        })
    }

    //保存
    $("#submitBtn").click(function () {
        // if (window.JsCallback) {
        //     var data = JSON.parse(window.JsCallback.onGetScrapList());
        //     EAdata(data)
        // } else {
        //     setupWebViewJavascriptBridge(function (bridge) {
        //         bridge.callHandler('onGetScrapList', function responseCallback(res) {
        //             EAdata(JSON.parse(res))
        //         })
        //     })
        // }
        var url = getURL() + '/AssetsDataPhone/mobile/summaryController.do?querySummary';

    })
    function EAdata() {
        var addUrl = getURL() + '/AssetsDataPhone/mobile/discardController.do?add';
        var eamDI = [], eamD = [];
        $.each(data, function () {
            var that = this;
            that.eamDiscardDetails.sl = $("#countall").val();
            that.eamDiscardInvoices.sl = $("#countall").val();
            that.eamDiscardInvoices.originalValue = $("input[name=originalValue]").val();
            that.eamDiscardInvoices.nowValue = $("input[name=nowValue]").val();
            that.eamDiscardInvoices.addDepreciate = $("input[name=addDepreciate]").val();
            that.eamDiscardInvoices.devalueValueSum = $("input[name=devalueValueSum]").val();
            eamDI.push(that.eamDiscardInvoices)
            eamD.push(that.eamDiscardDetails)
        })
        var jsons = {
            departCode: userInfo.departcode,
            userCode: userInfo.usercode,
            departName: userInfo.departname,
            userName: userInfo.username,
            eamDiscardInvoices: JSON.stringify(eamDI),
            eamDiscardDetails: JSON.stringify(eamD),
        }
        sendPost(addUrl, jsons, resA);
        function resA(res) {
            if (res.success == 'true') {
                $("#list1 .chose.active").closest('li').remove();
                if (window.JsCallback) {
                    var data = window.JsCallback.onClearScrapList();
                    if (data) {
                        alert("上传成功");
                        $(".check1").val("");
                        $(".check2").val("");
                        $("#dataBox span").text("");
                    }
                } else {
                    setupWebViewJavascriptBridge(function (bridge) {
                        bridge.callHandler('onClearScrapList', function responseCallback(data) {
                            if (data) {
                                alert("上传成功");
                            }
                        })
                    })
                }
            } else {
                alert(res.msg);
            }

        }
    }
    //传EAM、
    $("#submitBtn2").click(function () {
        var updataUrl = getURL() + '/AssetsDataPhone/mobile/discardController.do?confirm';
        var jsons = {
            departCode: userInfo.departcode,
            phoneInvoiceNumber: phoneInvoiceNumber,
        }
        sendPost(updataUrl, jsons, function (data) {
            if (data.success == 'true') {
                alert(data.msg)
            } else {
                alert(data.msg)
            }
        });
    })
    //传送审、
    $("#submitBtn3").click(function () {
        var updataUrl = getURL() + '/AssetsDataPhone/mobile/discardController.do?send';
        var jsons = {
            departCode: userInfo.departcode,
            userCode: userInfo.usercode,
            phoneInvoiceNumber: phoneInvoiceNumber,
        }
        sendPost(updataUrl, jsons, function (data) {
            if (data.success == 'true') {
                alert(data.msg)
            } else {
                alert(data.msg)
            }
        });
    })


    //扫描条形码功能    
    $("#scanning").click(function () {
        if (window.JsCallback) {
            //安卓
            window.JsCallback.onQR();
        } else {
            //IOS 
            setupWebViewJavascriptBridge(function (bridge) {
                bridge.callHandler('scanQR_AI', function responseCallback(responseData) {
                    scanData(responseData);
                })

            })
        }
    })
    function rnSetQRResult(result) {
        scanData(result);
    }
    function scanData(data) {
        var scanData = JSON.parse(data);
        var list = $("#list1 li");
        var BARcode = '';
        //barCode
        if (scanData.QRCodeLPC == undefined) {
            BARcode = scanData.barCode
        } else {
            BARcode = scanData.QRCodeLPC
        }
        if (list.length > 0) {
            var res = list.filter(function (index) {
                return $(this).attr("data-barcode") == BARcode;
            })
            if (res.length > 0) {
                //alert("明细已扫描");
                return false;
            }
        }
        $("input[name=barCode]").val(BARcode);
        $("#search").click();
    }

    // 价值 进行汇总
    function count(data) {
        var res = data.unique('assetsCode');
        $("#countall").val(res.length);
        var originalValue = 0, nowValue = 0, addDepreciate = 0, devalueValueSum = 0;
        $.each(res, function () {
            var that = this;
            originalValue += Number(that.eamDiscardInvoices.originalValue);
            nowValue += Number(that.eamDiscardInvoices.nowValue);
            addDepreciate += Number(that.eamDiscardInvoices.addDepreciate);
            devalueValueSum += Number(that.eamDiscardInvoices.devalueValueSum);
        })
        $("input[name=originalValue]").val(originalValue);
        $("input[name=nowValue]").val(nowValue);
        $("input[name=addDepreciate]").val(addDepreciate);
        $("input[name=devalueValueSum]").val(devalueValueSum);
    }

</script>

</html>